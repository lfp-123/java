<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SettleApportionRelaController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cib-crmp-rule</a> &gt; <a href="index.source.html" class="el_package">com.newland.boss.cib.crmp.controller</a> &gt; <span class="el_source">SettleApportionRelaController.java</span></div><h1>SettleApportionRelaController.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package com.newland.boss.cib.crmp.controller;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.List;

import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import com.alibaba.fastjson.JSONArray;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.newland.boss.cib.crmp.domain.RuleRela;
import com.newland.boss.cib.crmp.domain.SettleApportionRela;
import com.newland.boss.cib.crmp.service.SettleApportionRelaService;
import com.newland.boss.kpi.entity.OperateLog;
import com.newland.boss.kpi.server.OperateLogService;

/**
 * @author ylc
 *
 *         2018-05-11
 */
@RestController
<span class="fc" id="L35">public class SettleApportionRelaController {</span>

<span class="fc" id="L37">	private SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
	
<span class="fc" id="L39">	private static final Logger LOGGER = LogManager.getLogger(SettleApportionRelaController.class);</span>
	
	@Autowired
	private OperateLogService operateLogService;

	@Autowired
	private SettleApportionRelaService settleApportionRelaService;

	// 添加结算分配
	@RequestMapping(value = &quot;/addSettleApportionRela&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String addSettleApportionRela(@RequestBody String relaJson) {
<span class="fc" id="L50">		JsonParser jsonParser = new JsonParser();</span>
<span class="fc" id="L51">		JsonElement jsonEl = jsonParser.parse(relaJson);</span>
<span class="fc" id="L52">		JsonObject jsonObj = jsonEl.getAsJsonObject();</span>
<span class="fc" id="L53">		JsonArray relaArray = jsonObj.get(&quot;relaLists&quot;).getAsJsonArray();</span>
<span class="fc" id="L54">		StringBuilder idx = new StringBuilder();</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">		for (int i = 0; i &lt; relaArray.size(); i++) {</span>
<span class="fc" id="L56">			JsonObject obj = relaArray.get(i).getAsJsonObject();</span>
<span class="fc" id="L57">			idx.append(obj.get(&quot;apportionItemId&quot;).getAsInt()).append(&quot;,&quot;);</span>
		}
<span class="fc" id="L59">		operateLogRecord(jsonObj.get(&quot;operatorId&quot;).getAsInt(), 14, 1, &quot;批量新增单位结算摊分规则，单位ID：&quot; + jsonObj.get(&quot;orgId&quot;).getAsInt() + &quot;结算摊分规则ID&quot; + idx);</span>
<span class="fc" id="L60">		settleApportionRelaService.addSettleApportionRela(relaJson);</span>
<span class="fc" id="L61">		return JSONArray.toJSONString(settleApportionRelaService.loadSettleApportionRelaByOrgId(jsonObj.get(&quot;orgId&quot;).getAsInt()));</span>
	}

	// 多单位添加结算分配
	@RequestMapping(value = &quot;/addSettleApportionRelaByRuleId&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String addSettleApportionRelaByRuleId(@RequestBody List&lt;SettleApportionRela&gt; settleApportionRelaLists) {
<span class="fc" id="L67">		Integer operateId = settleApportionRelaLists.get(0).getOperatorId();</span>
<span class="fc" id="L68">		StringBuilder idx = new StringBuilder();</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">		if(settleApportionRelaLists.get(0).getObjectId() != null){</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">			for (SettleApportionRela settleApportionRela : settleApportionRelaLists) {</span>
<span class="fc" id="L71">				idx.append(settleApportionRela.getObjectId()).append(&quot;,&quot;);</span>
<span class="fc" id="L72">			}</span>
		}
<span class="fc" id="L74">		operateLogRecord(operateId, 14, 1, &quot;多单位添加结算摊分规则，规则ID：&quot; + settleApportionRelaLists.get(0).getApportionItemId() + &quot;单位ID：&quot; + idx);</span>
<span class="fc" id="L75">		settleApportionRelaService.addSettleApportionRelaByRuleId(settleApportionRelaLists);</span>
<span class="fc" id="L76">		return &quot;[{\&quot;result\&quot;:\&quot;true\&quot;}]&quot;;</span>
	}
	
	// 删除结算分配
	@RequestMapping(value = &quot;/deleteSettleApportionRela&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String deleteSettleApportionRela(@RequestBody String relaJson) {
<span class="fc" id="L82">		JsonParser jsonParser = new JsonParser();</span>
<span class="fc" id="L83">		JsonElement jsonEl = jsonParser.parse(relaJson);</span>
<span class="fc" id="L84">		JsonObject jsonObj = jsonEl.getAsJsonObject();</span>
<span class="fc" id="L85">		operateLogRecord(jsonObj.get(&quot;operatorId&quot;).getAsInt(), 14, 2, &quot;删除已分配的结算摊分规则：&quot; + jsonObj.get(&quot;relaIdJson&quot;).getAsJsonArray());</span>
<span class="fc" id="L86">		settleApportionRelaService.removeSettleApportionRela(relaJson);</span>
<span class="fc" id="L87">		return JSONArray.toJSONString(settleApportionRelaService.loadSettleApportionRelaByOrgId(jsonObj.get(&quot;orgId&quot;).getAsInt()));</span>
	}

	// 修改结算配置状态
	@RequestMapping(value = &quot;/modifySettleApportionRelaStatus&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String modifySettleApportionRelaStatus(@RequestBody String relaJson) {
<span class="fc" id="L93">		JsonParser jsonParser = new JsonParser();</span>
<span class="fc" id="L94">		JsonElement jsonEl = jsonParser.parse(relaJson);</span>
<span class="fc" id="L95">		JsonObject jsonObj = jsonEl.getAsJsonObject();</span>
<span class="fc" id="L96">		operateLogRecord(jsonObj.get(&quot;operatorId&quot;).getAsInt(), 14, 3, &quot;修改已分配的结算摊分规则的状态：摊分规则[&quot; + jsonObj.get(&quot;relaIdArray&quot;).getAsJsonArray() + &quot;],状态为：&quot; + jsonObj.get(&quot;relaStatus&quot;).getAsInt());</span>
<span class="fc" id="L97">		settleApportionRelaService.modifySettleApportionRelaStatus(relaJson);</span>
<span class="fc" id="L98">		return JSONArray.toJSONString(settleApportionRelaService.loadSettleApportionRelaByOrgId(jsonObj.get(&quot;orgId&quot;).getAsInt()));</span>
	}

	// 条件组合查询结算分配
	@RequestMapping(value = &quot;/loadComQueryRelaByParam&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String loadComQueryRelaByParam(@RequestBody RuleRela ruleRela) {
<span class="fc" id="L104">		return JSONArray.toJSONString(settleApportionRelaService.loadComQueryRelaByParam(changeDateFormat(ruleRela)));</span>
	}
		
	// 条件组合查询结算分配
	@RequestMapping(value = &quot;/loadComQueryRelaByOrgParam&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String loadComQueryRelaByOrgParam(@RequestBody String relaJson) {
<span class="fc" id="L110">		return JSONArray.toJSONString(settleApportionRelaService.loadComQueryRelaByOrgParam(relaJson));</span>
	}
	
	// 根据规则Id查询规则关系
	@RequestMapping(value = &quot;/loadSettleApportionRelaByRuleId&quot;, method = RequestMethod.GET, produces = &quot;text/json;charset=UTF-8&quot;)
	public String loadSettleApportionRelaByRuleId(@RequestParam Integer apportionItemId) {
<span class="fc" id="L116">		return JSONArray.toJSONString(settleApportionRelaService.loadSettleApportionRelaByRuleId(apportionItemId));</span>
	}
	
	// 根据组织查询规则关系
	@RequestMapping(value = &quot;/loadSettleApportionRelaByOrgId&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String loadSettleApportionRelaByOrgId(@RequestBody SettleApportionRela ruleRela) {
<span class="fc" id="L122">		return JSONArray.toJSONString(settleApportionRelaService.loadSettleApportionRelaByOrgId(ruleRela.getObjectId()));</span>
	}

	// 导出
	@RequestMapping(value = &quot;/exportSettleApportionRelaByParam&quot;, method = RequestMethod.POST, produces = &quot;text/json;charset=UTF-8&quot;)
	public String exportSettleApportionRelaByParam(@RequestBody String relaJson) {
<span class="fc" id="L128">		JsonParser jsonParser = new JsonParser();</span>
<span class="fc" id="L129">		JsonElement jsonEl = jsonParser.parse(relaJson);</span>
<span class="fc" id="L130">		JsonObject jsonObj = jsonEl.getAsJsonObject();		</span>
<span class="fc" id="L131">		operateLogRecord(jsonObj.get(&quot;operatorId&quot;).getAsInt(), 14, 5, &quot;根据条件导出已分配结算摊分规则：&quot; + relaJson);</span>
<span class="fc" id="L132">		return JSONArray.toJSONString(settleApportionRelaService.exportSettleApportionRela(relaJson));</span>
	}

	private void operateLogRecord(Integer operatorId, Integer operateModule, Integer operateType, String operateDesc) {
		// 添加操作日志到记录
<span class="fc" id="L137">		String regEx = &quot;[\\u4e00-\\u9fa5]&quot;;</span>
<span class="fc" id="L138">		OperateLog operateLog = new OperateLog();</span>
<span class="fc" id="L139">		operateLog.setOperatorId(operatorId);</span>
<span class="fc" id="L140">		operateLog.setOperateModule(operateModule);</span>
<span class="fc" id="L141">		operateLog.setOperateType(operateType);</span>
<span class="fc" id="L142">		int zwByte = operateDesc.length()-operateDesc.replaceAll(regEx, &quot;&quot;).length();</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">		operateLog.setOperateDesc(operateDesc.getBytes().length &gt; 230 ? operateDesc.substring(0, 230-2 * zwByte) : operateDesc);</span>
<span class="fc" id="L144">		operateLogService.addLog(operateLog);</span>
<span class="fc" id="L145">	}</span>
	
	/**
	 * 该方法用于解决前台传回来的时间，默认加8小时问题
	 * @param settleApportionRule
	 * @return
	 */
	private RuleRela changeDateFormat(RuleRela ruleRela) {
		try {
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			if (ruleRela.getInureDate() != null) {</span>
<span class="fc" id="L155">				ruleRela.setInureDate(sdf.parse(sdf.format(ruleRela.getInureDate())));</span>
			}
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">			if (ruleRela.getExpireDate() != null) {</span>
<span class="fc" id="L158">				ruleRela.setExpireDate(sdf.parse(sdf.format(ruleRela.getExpireDate())));</span>
			}
<span class="nc" id="L160">		} catch (ParseException e) {</span>
<span class="nc" id="L161">			LOGGER.debug(e.getMessage());</span>
<span class="fc" id="L162">		}</span>
<span class="fc" id="L163">		return ruleRela;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>