<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RateRuleServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cib-crmp-rule</a> &gt; <a href="index.source.html" class="el_package">com.newland.boss.cib.crmp.service.impl</a> &gt; <span class="el_source">RateRuleServiceImpl.java</span></div><h1>RateRuleServiceImpl.java</h1><pre class="source lang-java linenums">package com.newland.boss.cib.crmp.service.impl;

import java.io.File;
import java.io.IOException;
import java.net.URLEncoder;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.lang.math.NumberUtils;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.newland.boss.cib.crmp.common.JxlTool;
import com.newland.boss.cib.crmp.dao.RateRuleDao;
import com.newland.boss.cib.crmp.dao.RateRuleRelaDao;
import com.newland.boss.cib.crmp.domain.RateRule;
import com.newland.boss.cib.crmp.domain.RateRuleRela;
import com.newland.boss.cib.crmp.domain.RateRuleRelaView;
import com.newland.boss.cib.crmp.exception.ExcelParseException;
import com.newland.boss.cib.crmp.service.RateRuleRelaService;
import com.newland.boss.cib.crmp.service.RateRuleService;
import com.newland.boss.kpi.entity.DictDef;
import com.newland.boss.kpi.server.DictDefService;

import jxl.read.biff.BiffException;
import jxl.write.WriteException;

@Component
<span class="fc" id="L42">public class RateRuleServiceImpl implements RateRuleService {</span>

<span class="fc" id="L44">    private SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="fc" id="L45">    private SimpleDateFormat filesdf = new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;);</span>
    @Autowired
    private RateRuleDao rateRuleDao;

    @Autowired
    private RateRuleRelaDao rateRuleRelaDao;

    @Autowired
    private RateRuleRelaService rateRuleRelaService;

    @Autowired
    private DictDefService dictDefService;

<span class="fc" id="L58">    private static final Logger log = LogManager.getLogger(RateRuleServiceImpl.class);</span>

    private static final String STATUS = &quot;status&quot;;
    private static final String STATUSCODE = &quot;statuscode&quot;;
    private static final String INFO = &quot;info&quot;;
    private static final String FILENAME = &quot;filename&quot;;
    private static final String SUCCESS = &quot;success&quot;;
    private static final String FAIL = &quot;fail&quot;;

    /**
     * 根据ID查询数据字典
     * 
     * @return Map
     */
    public Map&lt;Integer, String&gt; getDicMap(Integer dicId) {
<span class="fc" id="L73">        Map&lt;Integer, String&gt; dicMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">        List&lt;DictDef&gt; dicList = dictDefService.getDictDefByDictClass(dicId);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        for (DictDef dictDef : dicList) {</span>
<span class="fc" id="L76">            dicMap.put(dictDef.getEntryId(), dictDef.getEntryName());</span>
<span class="fc" id="L77">        }</span>
<span class="fc" id="L78">        return dicMap;</span>
    }

    @Override
    public Map&lt;String, String&gt; addRateRule(RateRule rateRule) {
<span class="fc" id="L83">        Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L84">        boolean isCross = false;</span>
<span class="pc bpc" id="L85" title="1 of 4 branches missed.">        if (rateRule.getScope() == 1 &amp;&amp; !rateRuleDao.selectRuleCross(rateRule).isEmpty()) {</span>
<span class="nc" id="L86">            isCross = true;</span>
        }
<span class="pc bpc" id="L88" title="2 of 4 branches missed.">        if (rateRuleDao.searchSameRateRule(rateRule).isEmpty() &amp;&amp; !isCross) {</span>
<span class="fc" id="L89">            rateRuleDao.insertRateRule(rateRule);</span>
<span class="fc" id="L90">            resultMap.put(STATUS, SUCCESS);</span>
<span class="fc" id="L91">            resultMap.put(STATUSCODE, &quot;1&quot;);</span>
<span class="fc" id="L92">            resultMap.put(INFO, &quot;规则添加成功&quot;);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        } else if (isCross) {</span>
<span class="nc" id="L94">            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L95">            resultMap.put(STATUSCODE, &quot;2&quot;);</span>
<span class="nc" id="L96">            resultMap.put(INFO, &quot;该时段存在同类全局规则，规则添加失败&quot;);</span>
        } else {
<span class="nc" id="L98">            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L99">            resultMap.put(STATUSCODE, &quot;3&quot;);</span>
<span class="nc" id="L100">            resultMap.put(INFO, &quot;存在相同规则，规则添加失败&quot;);</span>
        }
<span class="fc" id="L102">        return resultMap;</span>
    }

    @Override
    public Map&lt;String, String&gt; editRateRule(RateRule rateRule) {
<span class="fc" id="L107">        Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (rateRule.getRateDesc() == null)</span>
<span class="fc" id="L109">            rateRule.setRateDesc(&quot;&quot;);</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (rateRule.getRateStatus() == 2</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                &amp;&amp; (!rateRuleRelaService.selectRateRuleRelaByRateItemId(rateRule.getRateItemId()).isEmpty())) {</span>
<span class="nc" id="L112">            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L113">            resultMap.put(INFO, &quot;改规则存在分配关系无法禁用，规则更新失败&quot;);</span>
<span class="pc bpc" id="L114" title="3 of 4 branches missed.">        } else if (rateRule.getScope() == 1 &amp;&amp; !rateRuleDao.selectRuleCross(rateRule).isEmpty()) {</span>
<span class="nc" id="L115">            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L116">            resultMap.put(INFO, &quot;该时段存在同类全局规则，规则更新失败&quot;);</span>
        } else {
<span class="fc" id="L118">            List&lt;RateRuleRela&gt; RelaList = rateRuleRelaService.selectRateRuleRelaByRateItemId(rateRule.getRateItemId());</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">            if (rateRule.getScope() == 0) {</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">                for (RateRuleRela rela : RelaList) {</span>
<span class="nc" id="L121">                    RateRuleRelaView relaView = rateRuleRelaService.RelaToview(rela);</span>
                    try {
<span class="nc" id="L123">                        relaView.setRateType(rateRule.getRateType());</span>
<span class="nc" id="L124">                        relaView.setInureDate(sdf.parse(rateRule.getInureDate()));</span>
<span class="nc" id="L125">                        relaView.setExpireDate(sdf.parse(rateRule.getExpireDate()));</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                        if (!rateRuleRelaDao.selectRuleRelaCross(relaView).isEmpty()) {</span>
<span class="nc" id="L127">                            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L128">                            resultMap.put(INFO, &quot;该规则存在分配关系，此次修改将引起时间冲突，修改失败&quot;);</span>
<span class="nc" id="L129">                            return resultMap;</span>
                        }
<span class="nc" id="L131">                    } catch (ParseException e) {</span>
<span class="nc" id="L132">                        log.debug(e.getMessage());</span>
<span class="nc" id="L133">                        resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L134">                        resultMap.put(INFO, &quot;时间转换出错&quot;);</span>
<span class="nc" id="L135">                        return resultMap;</span>
<span class="nc" id="L136">                    }</span>
<span class="nc" id="L137">                }</span>
            }
<span class="fc" id="L139">            rateRuleDao.updateRateRule(rateRule);</span>
            try {
<span class="fc" id="L141">                RateRuleRela relaupdate = new RateRuleRela();</span>
<span class="fc" id="L142">                relaupdate.setRateItemId(rateRule.getRateItemId());</span>
<span class="fc" id="L143">                relaupdate.setInureDate(sdf.parse(rateRule.getInureDate()));</span>
<span class="fc" id="L144">                relaupdate.setExpireDate(sdf.parse(rateRule.getExpireDate()));</span>
<span class="fc" id="L145">                rateRuleRelaDao.updateRateRuleRelaDate(relaupdate);</span>
<span class="nc" id="L146">            } catch (ParseException e) {</span>
<span class="nc" id="L147">                log.debug(e.getMessage());</span>
<span class="fc" id="L148">            }</span>
<span class="fc" id="L149">            resultMap.put(STATUS, SUCCESS);</span>
<span class="fc" id="L150">            resultMap.put(INFO, &quot;规则修改成功&quot;);</span>
        }
<span class="fc" id="L152">        return resultMap;</span>
    }

    @Override
    public void removeRateRule(String rateRuleJson) {
<span class="fc" id="L157">        JsonParser jsonParser = new JsonParser();</span>
<span class="fc" id="L158">        JsonElement jsonEl = jsonParser.parse(rateRuleJson);</span>
<span class="fc" id="L159">        JsonObject jsonObj = jsonEl.getAsJsonObject();</span>
<span class="fc" id="L160">        JsonArray rateRuleArray = jsonObj.get(&quot;rateItemIdArray&quot;).getAsJsonArray(); // 选中的资费规则</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        for (int i = 0; i &lt; rateRuleArray.size(); i++) {</span>
<span class="fc" id="L162">            Integer rateItemId = rateRuleArray.get(i).getAsInt();</span>
<span class="fc" id="L163">            rateRuleDao.deleteRateRule(rateItemId);</span>
<span class="fc" id="L164">            rateRuleRelaService.removeRateRuleRelaByRateItemId(rateItemId);</span>
        }

<span class="fc" id="L167">    }</span>

    @Override
    public List&lt;RateRule&gt; searchRateRule(RateRule rateRule) {
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (rateRule.getRateRuleName() != null) {</span>
<span class="nc" id="L172">            rateRule.setRateRuleName(rateRule.getRateRuleName().replaceAll(&quot;_&quot;, &quot;/_&quot;).replaceAll(&quot;%&quot;, &quot;/%&quot;));</span>
        }
<span class="fc" id="L174">        return rateRuleDao.searchRateRule(rateRule);</span>
    }

    @Override
    public Map&lt;String, String&gt; editRateRuleStatus(String rateRuleJson) {
<span class="fc" id="L179">        Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L180">        JsonParser jsonParser = new JsonParser();</span>
<span class="fc" id="L181">        JsonElement jsonEl = jsonParser.parse(rateRuleJson);</span>
<span class="fc" id="L182">        JsonObject jsonObj = jsonEl.getAsJsonObject();</span>
<span class="fc" id="L183">        JsonArray rateArray = jsonObj.get(&quot;rateItemIdArray&quot;).getAsJsonArray(); // 选中的rate</span>
<span class="fc" id="L184">        Integer rateStatus = jsonObj.get(&quot;rateStatus&quot;).getAsInt();// 要改变的规则状态</span>
<span class="fc" id="L185">        RateRule rateRule = new RateRule();</span>
<span class="fc" id="L186">        rateRule.setRateStatus(rateStatus);</span>
<span class="fc" id="L187">        List&lt;Integer&gt; rateItemIdList = new ArrayList&lt;&gt;();</span>
        // 循环更新规则状态
<span class="fc bfc" id="L189" title="All 2 branches covered.">        for (int i = 0; i &lt; rateArray.size(); i++) {</span>
<span class="fc" id="L190">            Integer rateItemId = rateArray.get(i).getAsInt();</span>
<span class="fc" id="L191">            rateRule.setRateItemId(rateItemId);</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (rateRule.getRateStatus() == 2</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                    &amp;&amp; (!rateRuleRelaService.selectRateRuleRelaByRateItemId(rateItemId).isEmpty())) {</span>
<span class="nc" id="L194">                rateItemIdList.add(rateItemId);</span>
<span class="nc" id="L195">                continue;</span>
            }
<span class="fc" id="L197">            rateRuleDao.updateRateRuleStatus(rateRule);</span>
        }
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (rateItemIdList.size() &gt; 0) {</span>
<span class="nc" id="L200">            String strID = &quot;&quot;;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            for (int j = 0; j &lt; rateItemIdList.size(); j++) {</span>
<span class="nc" id="L202">                strID = strID + rateItemIdList.get(j);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                if (j &lt; rateItemIdList.size() - 1) {</span>
<span class="nc" id="L204">                    strID = strID + &quot;、&quot;;</span>
                }
            }
<span class="nc" id="L207">            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L208">            resultMap.put(INFO, &quot;资费规则ID为：&quot; + strID + &quot;的规则存在分配关系无法禁用,请先解除分配关系。&quot;);</span>
<span class="nc" id="L209">        } else {</span>
<span class="fc" id="L210">            resultMap.put(STATUS, SUCCESS);</span>
        }
<span class="fc" id="L212">        return resultMap;</span>
    }

    @Override
    public Map&lt;String, String&gt; exportRateRule(List&lt;RateRule&gt; list) {
<span class="fc" id="L217">        Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L218">        Map&lt;Integer, String&gt; statusMap = getDicMap(1004);</span>
<span class="fc" id="L219">        Map&lt;Integer, String&gt; cdrTypeMap = getDicMap(1001);</span>
<span class="fc" id="L220">        Map&lt;Integer, String&gt; rateTypeMap = getDicMap(1006);</span>
<span class="fc" id="L221">        Map&lt;Integer, String&gt; scopeTypeMap = getDicMap(1019);</span>
<span class="fc" id="L222">        String title = &quot;RateRule&quot; + filesdf.format(new Date()) + &quot;.xls&quot;;</span>
<span class="fc" id="L223">        String path = System.getProperty(&quot;user.dir&quot;) + &quot;/downloadTemp/&quot; + title;</span>
<span class="fc" id="L224">        String[] columns = { &quot;规则ID&quot;, &quot;规则名称&quot;, &quot;资源类型&quot;, &quot;资费类型&quot;, &quot;范围&quot;, &quot;资费(元)&quot;, &quot;其他费用(元)&quot;,</span>
                /* &quot;开始时间(月-日:时)&quot;, &quot;结束时间(月-日:时)&quot;, (注释备用) */&quot;启用状态&quot;, &quot;生效时间&quot;, &quot;失效时间&quot;, &quot;资费说明&quot;, &quot;操作员ID&quot;, &quot;创建时间&quot; };
<span class="fc" id="L226">        boolean[] numberFlag = { false, false, false, false, false, false, false, false, false, false, false, false,</span>
                false };
<span class="fc" id="L228">        List&lt;String[]&gt; dataList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">        for (RateRule r : list) {</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            if (r.getRateDesc() == null)</span>
<span class="fc" id="L231">                r.setRateDesc(&quot;&quot;);</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">            if (r.getOtherFee() == null)</span>
<span class="fc" id="L233">                r.setOtherFee(0L);</span>
<span class="fc" id="L234">            String[] date = { String.valueOf(r.getRateItemId()), r.getRateRuleName(), cdrTypeMap.get(r.getCdrType()),</span>
<span class="fc" id="L235">                    rateTypeMap.get(r.getRateType()), scopeTypeMap.get(r.getScope()),</span>
<span class="fc" id="L236">                    String.valueOf(r.getFee() / 1000d), String.valueOf(r.getOtherFee() / 1000d),</span>
                    /* String.valueOf(r.getStartTime()), String.valueOf(r.getEndTime()),(注释备用) */ statusMap
<span class="fc" id="L238">                            .get(r.getRateStatus()),</span>
<span class="fc" id="L239">                    r.getInureDate(), r.getExpireDate(), String.valueOf(r.getRateDesc()),</span>
<span class="fc" id="L240">                    String.valueOf(r.getOperatorId()), r.getCreateTime() };</span>
<span class="fc" id="L241">            dataList.add(date);</span>
<span class="fc" id="L242">        }</span>
        try {
<span class="fc" id="L244">            JxlTool.exportExcel(path, columns, dataList, numberFlag);</span>
<span class="fc" id="L245">            resultMap.put(STATUS, SUCCESS);</span>
<span class="fc" id="L246">            resultMap.put(FILENAME, URLEncoder.encode(title, &quot;UTF-8&quot;));</span>
<span class="nc" id="L247">        } catch (WriteException | IOException e) {</span>
<span class="nc" id="L248">            log.debug(e.getMessage());</span>
<span class="nc" id="L249">            resultMap.put(STATUS, FAIL);</span>
<span class="nc" id="L250">            resultMap.put(INFO, e.getMessage());</span>
<span class="fc" id="L251">        }</span>
<span class="fc" id="L252">        return resultMap;</span>
    }

    @Override
    public Map&lt;String, String&gt; importRateRule(String path, Integer operatorId) {
<span class="fc" id="L257">        Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L258">        resultMap.put(SUCCESS, &quot;规则导入全部失败&quot;);</span>
<span class="fc" id="L259">        int addnum = 0;</span>
        try {
<span class="fc" id="L261">            List&lt;String[]&gt; dataList = JxlTool.importExcel(path, 0);</span>
<span class="fc" id="L262">            File file = new File(path);</span>
<span class="pc bpc" id="L263" title="3 of 6 branches missed.">            if (file.exists() &amp;&amp; file.isFile() &amp;&amp; !file.delete()) {</span>
<span class="nc" id="L264">                log.debug(&quot;删除资费规则导入文件失败。&quot;);</span>
            }
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">            for (int j = 1; j &lt; dataList.size(); j++) {</span>

<span class="fc" id="L268">                String[] s = dataList.get(j);</span>
<span class="pc bpc" id="L269" title="9 of 10 branches missed.">                if (&quot;&quot;.equals(s[0]) &amp;&amp; &quot;&quot;.equals(s[1]) &amp;&amp; &quot;&quot;.equals(s[2]) &amp;&amp; &quot;&quot;.equals(s[3]) &amp;&amp; &quot;&quot;.equals(s[6])</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">                        &amp;&amp; &quot;&quot;.equals(s[7]) &amp;&amp; &quot;&quot;.equals(s[8])) {</span>
<span class="nc" id="L271">                    break;</span>
                }
<span class="pc bpc" id="L273" title="5 of 10 branches missed.">                if (&quot;&quot;.equals(s[0]) || &quot;&quot;.equals(s[1]) || &quot;&quot;.equals(s[2]) || &quot;&quot;.equals(s[3]) || &quot;&quot;.equals(s[6])</span>
<span class="pc bpc" id="L274" title="2 of 4 branches missed.">                        || &quot;&quot;.equals(s[7]) || &quot;&quot;.equals(s[8])) {</span>
<span class="nc" id="L275">                    throw new ExcelParseException(&quot;该行有必填数据为空，请检查！&quot;);</span>

                }
<span class="fc" id="L278">                RateRule rateRule = dealDataFormat(dataList.get(j), operatorId);</span>

<span class="fc" id="L280">                Map&lt;String, String&gt; addMap = addRateRule(rateRule);</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">                if (&quot;2&quot;.equals(addMap.get(STATUSCODE))) {</span>
<span class="nc" id="L282">                    throw new ExcelParseException(&quot;该时段存在同类全局规则，请检查！&quot;);</span>
                }
<span class="fc" id="L284">                addnum++;</span>
            }
<span class="nc" id="L286">            resultMap.put(SUCCESS, &quot;导入资费规则成功,成功导入&quot; + addnum + &quot;条规则&quot;);</span>
<span class="fc" id="L287">        } catch (ExcelParseException | BiffException | IOException e) {</span>
<span class="fc" id="L288">            log.debug(&quot;Excel文件格式转换异常&quot; + e.getMessage());</span>
<span class="fc" id="L289">            resultMap.put(SUCCESS, &quot;导入资费规则执行至第&quot; + (addnum + 2) + &quot;行停止,&quot; + e.getMessage());</span>
<span class="nc" id="L290">        }</span>
<span class="fc" id="L291">        return resultMap;</span>
    }

    private RateRule dealDataFormat(String[] data, Integer operatorId) {
<span class="fc" id="L295">        Map&lt;Integer, String&gt; statusMap = getDicMap(1004);</span>
<span class="fc" id="L296">        Map&lt;Integer, String&gt; cdrTypeMap = getDicMap(1001);</span>
<span class="fc" id="L297">        Map&lt;Integer, String&gt; rateTypeMap = getDicMap(1006);</span>
<span class="fc" id="L298">        Map&lt;Integer, String&gt; scopeTypeMap = getDicMap(1019);</span>
<span class="fc" id="L299">        String[] s = data;</span>
<span class="fc" id="L300">        RateRule rateRule = new RateRule();</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">        if (length(s[0]) &gt; 32) {</span>
<span class="nc" id="L302">            throw new ExcelParseException(&quot;规则名称太长，请检查！&quot;);</span>
        } else {
<span class="fc" id="L304">            rateRule.setRateRuleName(s[0]);</span>
        }
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">        if (getKey(cdrTypeMap, s[1]) == null) {</span>
<span class="nc" id="L307">            throw new ExcelParseException(&quot;资源类型信息不匹配，请检查！&quot;);</span>
        } else {
<span class="fc" id="L309">            rateRule.setCdrType(getKey(cdrTypeMap, s[1]));</span>
        }
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (getKey(rateTypeMap, s[2]) == null) {</span>
<span class="nc" id="L312">            throw new ExcelParseException(&quot;资费类型信息不匹配，请检查！&quot;);</span>
        } else {
<span class="fc" id="L314">            rateRule.setRateType(getKey(rateTypeMap, s[2]));</span>
        }
<span class="fc bfc" id="L316" title="All 2 branches covered.">        if (!isRelativeType(rateRule.getCdrType(), rateRule.getRateType())) {</span>
<span class="fc" id="L317">            throw new ExcelParseException(&quot;资源类型与资费类型不匹配，请检查！&quot;);</span>
        } else {
<span class="fc" id="L319">            rateRule.setRateType(getKey(rateTypeMap, s[2]));</span>
        }
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if (getKey(scopeTypeMap, s[3]) == null) {</span>
<span class="nc" id="L322">            throw new ExcelParseException(&quot;规则范围信息不匹配，请检查！&quot;);</span>
        } else {
<span class="fc" id="L324">            rateRule.setScope(getKey(scopeTypeMap, s[3]));</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">            if (rateRule.getRateType() == 10) {</span>
<span class="nc" id="L326">                rateRule.setScope(1);</span>
            }
        }
<span class="fc bfc" id="L329" title="All 2 branches covered.">        if (&quot;&quot;.equals(s[4])) {</span>
<span class="fc" id="L330">            s[4] = &quot;0&quot;;</span>
        }
<span class="fc bfc" id="L332" title="All 2 branches covered.">        if (&quot;&quot;.equals(s[5])) {</span>
<span class="fc" id="L333">            s[5] = &quot;0&quot;;</span>
        }
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        if (isNumber(s[4]) == null) {</span>
<span class="nc" id="L336">            throw new ExcelParseException(&quot;资费格式有误，请检查！&quot;);</span>
        } else {
<span class="fc" id="L338">            rateRule.setFee(Math.round(isNumber(s[4]) * 1000));</span>
        }
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">        if (isNumber(s[5]) == null) {</span>
<span class="nc" id="L341">            throw new ExcelParseException(&quot;其他费用格式有误，请检查！&quot;);</span>
        } else {
<span class="fc" id="L343">            rateRule.setOtherFee(Math.round(isNumber(s[5]) * 1000));</span>
        }
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">        if (getKey(statusMap, s[6]) == null) {</span>
<span class="nc" id="L346">            throw new ExcelParseException(&quot;规则状态信息不匹配，请检查！&quot;);</span>
        } else {
<span class="fc" id="L348">            rateRule.setRateStatus(getKey(statusMap, s[6]));</span>
        }
<span class="pc bpc" id="L350" title="3 of 6 branches missed.">        if (realDate(s[7]) == null || realDate(s[8]) == null || isDateError(s[7], s[8])) {</span>
<span class="nc" id="L351">            throw new ExcelParseException(&quot;生效时间或失效时间错误，请检查！&quot;);</span>
        } else {
<span class="fc" id="L353">            rateRule.setInureDate(realDate(s[7]));</span>
<span class="fc" id="L354">            rateRule.setExpireDate(realDate(s[8]));</span>
        }
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">        if (length(s[9]) &gt; 512) {</span>
<span class="nc" id="L357">            throw new ExcelParseException(&quot;备注太长，请检查！&quot;);</span>
        } else {
<span class="fc" id="L359">            rateRule.setRateDesc(s[9]);</span>
        }
<span class="pc bpc" id="L361" title="2 of 6 branches missed.">        if (rateRule.getRateType() == 3 || rateRule.getRateType() == 4 || rateRule.getRateType() == 5</span>
<span class="pc bpc" id="L362" title="1 of 6 branches missed.">                || rateRule.getRateType() == 6 || rateRule.getRateType() == 8 || rateRule.getRateType() == 9</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">                || rateRule.getRateType() == 10) {</span>
<span class="fc" id="L364">            rateRule.setFee(0L);</span>
        }
<span class="pc bpc" id="L366" title="1 of 6 branches missed.">        if (rateRule.getRateType() == 1 || rateRule.getRateType() == 2 || rateRule.getRateType() == 7) {</span>
<span class="fc" id="L367">            rateRule.setOtherFee(0L);</span>
        }
<span class="fc" id="L369">        rateRule.setOperatorId(operatorId);</span>
<span class="fc" id="L370">        rateRule.setCreateTime(sdf.format(new Date()));</span>
<span class="fc" id="L371">        setPriority(rateRule);</span>
<span class="fc" id="L372">        return rateRule;</span>
    }

    /**
     * 通过Key值获取value
     * 
     * @param map
     * @param value
     * @return
     */
    private Integer getKey(Map&lt;Integer, String&gt; map, String value) {
<span class="fc" id="L383">        Integer key = null;</span>
<span class="fc" id="L384">        Set&lt;?&gt; set = map.entrySet();</span>
<span class="fc" id="L385">        Iterator&lt;?&gt; it = set.iterator();</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">        while (it.hasNext()) {</span>
            @SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L388">            Map.Entry entry = (Map.Entry) it.next();</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">            if (entry.getValue().equals(value)) {</span>
<span class="fc" id="L390">                key = Integer.valueOf(entry.getKey().toString());</span>
            }
<span class="fc" id="L392">        }</span>
<span class="fc" id="L393">        return key;</span>
    }

    /**
     * 计算规则优先级
     * 
     * @param rateRule
     */
    private void setPriority(RateRule rateRule) {
<span class="fc bfc" id="L402" title="All 2 branches covered.">        if (rateRule.getRateType() == 8) {</span>
<span class="fc" id="L403">            rateRule.setPriority(-1);</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">        } else if (rateRule.getRateType() == 10) {</span>
<span class="nc" id="L405">            rateRule.setPriority(-1);</span>
        } else {
<span class="fc bfc" id="L407" title="All 2 branches covered.">                if (rateRule.getRateType() == 3) {</span>
<span class="fc" id="L408">                    rateRule.setPriority(3);</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">                } else if (rateRule.getRateType() == 4) {</span>
<span class="nc" id="L410">                    rateRule.setPriority(4);</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">                } else if (rateRule.getRateType() == 5) {</span>
<span class="nc" id="L412">                    rateRule.setPriority(5);</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">                } else if (rateRule.getRateType() == 6) {</span>
<span class="fc" id="L414">                    rateRule.setPriority(6);</span>
                } else {
<span class="fc" id="L416">                    rateRule.setPriority(2);</span>
                }
        }
<span class="fc" id="L419">    }</span>

    /**
     * 判断规则中的资费类型与收费类型是否是对应的
     * 
     * @param cdrType  资费类型
     * @param rateType 收费类型
     * @return
     */
    Boolean isRelativeType(Integer cdrType, Integer rateType) {
<span class="pc bpc" id="L429" title="4 of 12 branches missed.">        return ((cdrType == 1 &amp;&amp; (rateType == 1 || rateType == 3 || rateType == 6 || rateType == 8 || rateType == 10))</span>
<span class="pc bpc" id="L430" title="6 of 10 branches missed.">                || (cdrType == 2 &amp;&amp; rateType == 1) || (cdrType == 3 &amp;&amp; (rateType == 2 || rateType == 9))</span>
<span class="pc bpc" id="L431" title="1 of 6 branches missed.">                || (cdrType == 4 &amp;&amp; (rateType == 3 || rateType == 6)));</span>
    }

    /**
     * 导入时间格式转化
     * 
     * @param sDate
     * @return
     */
    private String realDate(String sDate) {
        try {
<span class="fc" id="L442">            sdf.parse(sDate);</span>
<span class="nc" id="L443">        } catch (ParseException e) {</span>
<span class="nc" id="L444">            return null;</span>
<span class="fc" id="L445">        }</span>
<span class="fc" id="L446">        return sDate;</span>
    }

    private Boolean isDateError(String iInureDate, String iExpireDate) {
<span class="fc" id="L450">        Boolean correct = false;</span>
        try {
<span class="fc" id="L452">            Date inureDate = sdf.parse(iInureDate);</span>
<span class="fc" id="L453">            Date expireDate = sdf.parse(iExpireDate);</span>
<span class="pc bpc" id="L454" title="2 of 4 branches missed.">            if (inureDate.after(expireDate) || expireDate.after(sdf.parse(&quot;3000-01-01&quot;))</span>
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">                    || inureDate.before(sdf.parse(&quot;1900-01-01&quot;))) {</span>
<span class="nc" id="L456">                correct = true;</span>
            }
<span class="nc" id="L458">        } catch (ParseException e) {</span>
<span class="nc" id="L459">            return true;</span>
<span class="fc" id="L460">        }</span>
<span class="fc" id="L461">        return correct;</span>
    }

    /*
     * private String checkTimeFormate(String stime) { String time=null; String
     * regex=&quot;(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1]):([0-1][0-9]|2[0-3])&quot;;//
     * 正则表达式 Pattern p=Pattern.compile(regex); Matcher m=p.matcher(stime);
     * if(m.matches()){ time=stime; } return time; }
     */
    /**
     * 计算字符串字符长度
     * 
     * @param str
     * @return
     */
    private int length(String str) {
<span class="fc" id="L477">        int strLength = 0;</span>
<span class="fc" id="L478">        String chinese = &quot;[\u0391-\uFFE5]&quot;;</span>
        /* 获取字段值的长度，如果含中文字符，则每个中文字符长度为2，否则为1 */
<span class="fc bfc" id="L480" title="All 2 branches covered.">        for (int i = 0; i &lt; str.length(); i++) {</span>
            /* 获取一个字符 */
<span class="fc" id="L482">            String temp = str.substring(i, i + 1);</span>
            /* 判断是否为中文字符 */
<span class="fc bfc" id="L484" title="All 2 branches covered.">            if (temp.matches(chinese)) {</span>
                /* 中文字符长度为2 */
<span class="fc" id="L486">                strLength += 2;</span>
            } else {
                /* 其他字符长度为1 */
<span class="fc" id="L489">                strLength += 1;</span>
            }
        }
<span class="fc" id="L492">        return strLength;</span>
    }

    /**
     * 判断是否为数字类型，是则返回double数据，否返回空
     * 
     * @param sNumber
     * @return
     */
    private Double isNumber(String sNumber) {
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">        if (NumberUtils.isNumber(sNumber))</span>
<span class="fc" id="L503">            return Double.valueOf(sNumber);</span>
        else
<span class="nc" id="L505">            return null;</span>
    }

    @Override
    public List&lt;RateRule&gt; searchRateRuleToDistribute(RateRule rateRule) {
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">        if (rateRule.getRateRuleName() != null) {</span>
<span class="nc" id="L511">            rateRule.setRateRuleName(rateRule.getRateRuleName().replaceAll(&quot;_&quot;, &quot;/_&quot;).replaceAll(&quot;%&quot;, &quot;/%&quot;));</span>
        }
<span class="fc" id="L513">        return rateRuleDao.searchRuleToDistribute(rateRule);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>