<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QueryCallListServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cib-crmp-settle</a> &gt; <a href="index.source.html" class="el_package">com.newland.boss.cib.crmp.settle.service.impl</a> &gt; <span class="el_source">QueryCallListServiceImpl.java</span></div><h1>QueryCallListServiceImpl.java</h1><pre class="source lang-java linenums">package com.newland.boss.cib.crmp.settle.service.impl;

import java.net.URLEncoder;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.newland.boss.cib.crmp.common.JxlTool;
import com.newland.boss.cib.crmp.dao.RateRuleDao;
import com.newland.boss.cib.crmp.domain.QueryCallListReq;
import com.newland.boss.cib.crmp.domain.QueryCallListResp;
import com.newland.boss.cib.crmp.domain.RateRule;
import com.newland.boss.cib.crmp.domain.RatedCdr;
import com.newland.boss.cib.crmp.domain.RatedDma;
import com.newland.boss.cib.crmp.domain.RatedNetwork;
import com.newland.boss.cib.crmp.domain.SummingSettleTask;
import com.newland.boss.cib.crmp.settle.dao.RatedCdrDao;
import com.newland.boss.cib.crmp.settle.dao.RatedDmaDao;
import com.newland.boss.cib.crmp.settle.dao.RatedNetworkDao;
import com.newland.boss.cib.crmp.settle.service.QueryCallListService;
import com.newland.boss.kpi.admin.dao.OperatorDao;
import com.newland.boss.kpi.admin.model.Operator;

@Component
<span class="fc" id="L35">public class QueryCallListServiceImpl implements QueryCallListService {</span>

<span class="fc" id="L37">	private static final Logger LOGGER = LogManager.getLogger(QueryCallListServiceImpl.class);</span>

	@Autowired
	private RatedCdrDao ratedCdrDao;
	@Autowired
	private RatedDmaDao ratedDmaDao;
	@Autowired
	private RatedNetworkDao ratedNetworkDao;
	@Autowired
	private OperatorDao operatorDao;
	@Autowired
	private RateRuleDao rateRuleDao;

	private static final String FULL_DATE_FORMAT = &quot;yyyy-MM-dd HH:mm:ss&quot;;
<span class="fc" id="L51">	private SimpleDateFormat simpleDateFormat = new SimpleDateFormat(FULL_DATE_FORMAT);</span>
<span class="fc" id="L52">	private SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;);</span>
	private static final String FILE_NAME = &quot;fileName&quot;;
<span class="fc" id="L54">	private static final String PATH = System.getProperty(&quot;user.dir&quot;) + &quot;/downloadTemp/&quot;;</span>
	private static final String FEE = &quot;费用/(元)&quot;;
	private static final String LOGIN_NAME = &quot;notes名&quot;;
	private static final String ERROR = &quot;error&quot;;
	private static final String SUCCESS = &quot;success&quot;;
	private static final String STATUS = &quot;status&quot;;

	@Override
	public Map&lt;String, Object&gt; queryCallListResult(QueryCallListReq req, int page, int size) {
<span class="fc" id="L63">		List&lt;QueryCallListResp&gt; callList = new ArrayList&lt;QueryCallListResp&gt;();</span>
<span class="fc" id="L64">		long total = 0l;</span>
<span class="fc" id="L65">		String resourceType = req.getResourceType();</span>
<span class="fc" id="L66">		Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L67">		PageHelper.clearPage();</span>
<span class="fc" id="L68">		PageHelper.startPage(page, size);</span>

<span class="fc bfc" id="L70" title="All 2 branches covered.">		if (&quot;1&quot;.equals(resourceType)) {</span>
<span class="fc" id="L71">			List&lt;RatedCdr&gt; originList = ratedCdrDao.queryCdrCallListResult(req);</span>
<span class="fc" id="L72">			PageInfo&lt;RatedCdr&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L73">			total = pageInfo.getTotal();</span>
<span class="fc" id="L74">			List&lt;RatedCdr&gt; list = pageInfo.getList();</span>
<span class="fc" id="L75">			cdrListToRespList(callList, list, req.getCallType());</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">		} else if (&quot;2&quot;.equals(resourceType)) {</span>
<span class="fc" id="L77">			List&lt;RatedDma&gt; originList = ratedDmaDao.queryDmaCallListResult(req);</span>
<span class="fc" id="L78">			PageInfo&lt;RatedDma&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L79">			total = pageInfo.getTotal();</span>
<span class="fc" id="L80">			List&lt;RatedDma&gt; list = pageInfo.getList();</span>
<span class="fc" id="L81">			dmaListToRespList(callList, list);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">		} else if (&quot;3&quot;.equals(resourceType)) {</span>
<span class="fc" id="L83">			List&lt;RatedNetwork&gt; originList = ratedNetworkDao.queryNetworkCallListResult(req);</span>
<span class="fc" id="L84">			PageInfo&lt;RatedNetwork&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L85">			total = pageInfo.getTotal();</span>
<span class="fc" id="L86">			List&lt;RatedNetwork&gt; list = pageInfo.getList();</span>
<span class="fc" id="L87">			networkListToRespList(callList, list);</span>
		}
<span class="fc" id="L89">		map.put(&quot;list&quot;, callList);</span>
<span class="fc" id="L90">		map.put(&quot;cnt&quot;, total);</span>
<span class="fc" id="L91">		return map;</span>
	}

//	@Override
//	public int queryCallListCount(QueryCallListReq req) {
//		String resourceType = req.getResourceType();
//		int count = 0;
//		if (&quot;1&quot;.equals(resourceType)) {
//			count = ratedCdrDao.queryCdrCallListCount(req);
//		} else if (&quot;2&quot;.equals(resourceType)) {
//			count = ratedDmaDao.queryDmaCallListCount(req);
//		} else if (&quot;3&quot;.equals(resourceType)) {
//			count = ratedNetworkDao.queryNetworkCallListCount(req);
//		}
//		return count;
//	}

	@Override
	public Map&lt;String, String&gt; createCallListExcel(QueryCallListReq req) {
<span class="fc" id="L110">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L111">		String resourceType = req.getResourceType();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">		if (&quot;1&quot;.equals(resourceType)) {</span>
<span class="fc" id="L113">			map = createCdrCallListExcel(req);</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">		} else if (&quot;2&quot;.equals(resourceType)) {</span>
<span class="pc bpc" id="L115" title="3 of 4 branches missed.">			if (req.getLoginName() != null &amp;&amp; !(&quot;&quot;.equals(req.getLoginName()))) {</span>
<span class="nc" id="L116">				Operator operator = operatorDao.findByLoginName(req.getLoginName());</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">				if (operator != null) {</span>
<span class="nc" id="L118">					req.setOperatorId(String.valueOf(operator.getOperatorId()));</span>
				} else {
<span class="nc" id="L120">					req.setOperatorId(&quot;-2&quot;);</span>
				}
			}
<span class="fc" id="L123">			map = createDmaCallListExcel(req);</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		} else if (&quot;3&quot;.equals(resourceType)) {</span>
<span class="fc" id="L125">			List&lt;RatedNetwork&gt; list = ratedNetworkDao.queryNetworkCallListResult(req);</span>
<span class="fc" id="L126">			map = createNetworkExcel(list, &quot;网络专线话单&quot;+dateFormat.format(new Date())+&quot;.xls&quot;);</span>
		}
<span class="fc" id="L128">		return map;</span>
	}

	private Map&lt;String, String&gt; createDmaCallListExcel(QueryCallListReq req) {
		Map&lt;String, String&gt; map;
<span class="fc" id="L133">		List&lt;RatedDma&gt; list = ratedDmaDao.queryDmaCallListResult(req);</span>

<span class="fc" id="L135">		String[] columns = { LOGIN_NAME, &quot;姓名&quot;, &quot;单位名称&quot;, &quot;方数&quot;, &quot;会议号&quot;, &quot;会议起始时间&quot;, &quot;会议结束时间&quot;, &quot;时长/(时)&quot;, FEE, &quot;保障费/(元)&quot; };</span>
<span class="fc" id="L136">		boolean[] numberFlag = { false, false, false, false, false, false, false, false, true, true };</span>
<span class="fc" id="L137">		List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">		for (RatedDma r : list) {</span>
<span class="fc" id="L139">			double holdingTime = (double) r.getHoldingTime() / (60 * 60);</span>
<span class="fc" id="L140">			String[] data = { String.valueOf(r.getUserId()), String.valueOf(r.getOperatorName()),</span>
<span class="fc" id="L141">					String.valueOf(r.getOrgName()),</span>
<span class="fc" id="L142">					String.valueOf(r.getPartCount()), String.valueOf(r.getRoomId()),</span>
<span class="fc" id="L143">					simpleDateFormat.format(r.getStartTime()), simpleDateFormat.format(r.getEndTime()),</span>
<span class="fc" id="L144">					String.valueOf((long) Math.ceil(holdingTime)),</span>
<span class="fc" id="L145">					String.valueOf((double) r.getFee() / 1000),</span>
<span class="fc" id="L146">					String.valueOf((double) r.getOtherFee() / 1000) };</span>
<span class="fc" id="L147">			dataList.add(data);</span>
<span class="fc" id="L148">		}</span>
<span class="fc" id="L149">		map = createExcel(&quot;dma话单&quot;+dateFormat.format(new Date())+&quot;.xls&quot;, columns, dataList, numberFlag);</span>
<span class="fc" id="L150">		return map;</span>
	}

	private Map&lt;String, String&gt; createCdrCallListExcel(QueryCallListReq req) {
		Map&lt;String, String&gt; map;
<span class="fc" id="L155">		List&lt;RatedCdr&gt; list = ratedCdrDao.queryCdrCallListResult(req);</span>
<span class="fc" id="L156">		List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc" id="L157">		String[] columns = { LOGIN_NAME, &quot;姓名&quot;, &quot;单位名称&quot;, &quot;主叫号码&quot;, &quot;被叫号码&quot;, &quot;话单类型&quot;, &quot;通话起始时间&quot;, &quot;通话结束时间&quot;, &quot;时长/(分)&quot;, FEE };</span>
<span class="fc" id="L158">		boolean[] numberFlag = { false, false, false, false, false, false, false, false, true, true };// 设置第9、10个字段为数字类型</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">		for (RatedCdr r : list) {</span>
<span class="fc" id="L160">			double holdingTime = (double) r.getHoldingTime() / 60;</span>
<span class="fc" id="L161">			String startTime = &quot;&quot;;</span>
<span class="fc" id="L162">			String endTime = &quot;&quot;;</span>
<span class="pc bpc" id="L163" title="2 of 4 branches missed.">			if (r.getEndTime() != null &amp;&amp; r.getStartTime() != null) {</span>
<span class="fc" id="L164">				startTime = simpleDateFormat.format(r.getStartTime());</span>
<span class="fc" id="L165">				endTime = simpleDateFormat.format(r.getEndTime());</span>
			}
<span class="fc" id="L167">			String[] data = { String.valueOf(r.getUserId()), String.valueOf(r.getOperatorName()),</span>
<span class="fc" id="L168">					String.valueOf(r.getOrgName()), String.valueOf(r.getCallNumber()),</span>
<span class="fc" id="L169">					String.valueOf(r.getCalledNumber()), r.getCallTypeName(), startTime, endTime,</span>
<span class="fc" id="L170">					String.valueOf((long) Math.ceil(holdingTime)), String.valueOf((double) r.getFee() / 1000) };</span>
<span class="fc" id="L171">			dataList.add(data);</span>
<span class="fc" id="L172">		}</span>
<span class="fc" id="L173">		map = createExcel(&quot;cdr话单&quot;+dateFormat.format(new Date())+&quot;.xls&quot;, columns, dataList, numberFlag);</span>
<span class="fc" id="L174">		return map;</span>
	}

	@Override
	public Map&lt;String, Object&gt; queryBlackCallListResult(QueryCallListReq req, int page, int size) {
<span class="fc" id="L179">		List&lt;QueryCallListResp&gt; callList = new ArrayList&lt;QueryCallListResp&gt;();</span>
<span class="fc" id="L180">		String resourceType = req.getResourceType();</span>
<span class="fc" id="L181">		Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L182">		PageHelper.clearPage();</span>
<span class="fc" id="L183">		PageHelper.startPage(page, size);</span>
<span class="fc" id="L184">		long total = 0l;</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">		if (&quot;1&quot;.equals(resourceType)) {</span>
			// cdr
<span class="fc" id="L187">			List&lt;RatedCdr&gt; originList = ratedCdrDao.queryCdrBlackCallListResult(req);</span>
<span class="fc" id="L188">			PageInfo&lt;RatedCdr&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L189">			total = pageInfo.getTotal();</span>
<span class="fc" id="L190">			List&lt;RatedCdr&gt; list = pageInfo.getList();</span>
<span class="fc" id="L191">			cdrListToRespList(callList, list, req.getCallType());</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">		} else if (&quot;2&quot;.equals(resourceType)) {</span>
			// dma
<span class="fc" id="L194">			List&lt;RatedDma&gt; originList = ratedDmaDao.queryDmaBlackCallListResult(req);</span>
<span class="fc" id="L195">			PageInfo&lt;RatedDma&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L196">			total = pageInfo.getTotal();</span>
<span class="fc" id="L197">			List&lt;RatedDma&gt; list = pageInfo.getList();</span>
<span class="fc" id="L198">			dmaListToRespList(callList, list);</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		} else if (&quot;3&quot;.equals(resourceType)) {</span>
			// network
<span class="fc" id="L201">			List&lt;RatedNetwork&gt; originList = ratedNetworkDao.queryNetworkBlackCallListResult(req);</span>
<span class="fc" id="L202">			PageInfo&lt;RatedNetwork&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L203">			total = pageInfo.getTotal();</span>
<span class="fc" id="L204">			List&lt;RatedNetwork&gt; list = pageInfo.getList();</span>
<span class="fc" id="L205">			networkListToRespList(callList, list);</span>
		}
<span class="fc" id="L207">		map.put(&quot;list&quot;, callList);</span>
<span class="fc" id="L208">		map.put(&quot;cnt&quot;, total);</span>
<span class="fc" id="L209">		return map;</span>
	}

//	@Override
//	public int queryBlackCallListCount(QueryCallListReq req) {
//		String resourceType = req.getResourceType();
//		int count = 0;
//		if (&quot;1&quot;.equals(resourceType)) {
//			count = ratedCdrDao.queryCdrBlackCallListCount(req);
//		} else if (&quot;2&quot;.equals(resourceType)) {
//			count = ratedDmaDao.queryDmaBlackCallListCount(req);
//		} else if (&quot;3&quot;.equals(resourceType)) {
//			count = ratedNetworkDao.queryNetworkBlackCallListCount(req);
//		}
//		return count;
//	}

	@Override
	public Map&lt;String, String&gt; createBlackCallListExcel(QueryCallListReq req) {
<span class="fc" id="L228">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L229">		String resourceType = req.getResourceType();</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">		if (&quot;1&quot;.equals(resourceType)) {</span>
<span class="fc" id="L231">			List&lt;RatedCdr&gt; list = ratedCdrDao.queryCdrBlackCallListResult(req);</span>
<span class="fc" id="L232">			List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc" id="L233">			String[] columns = { &quot;主叫号码&quot;, &quot;被叫号码&quot;, &quot;话单类型&quot;, &quot;通话起始时间&quot;, &quot;通话结束时间&quot;, &quot;时长/(分)&quot;, FEE };</span>
<span class="fc" id="L234">			boolean[] numberFlag = { false, false, false, false, false, true, true };</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">			for (RatedCdr r : list) {</span>
<span class="fc" id="L236">				double holdingTime = (double) r.getHoldingTime() / 60;</span>
<span class="fc" id="L237">				String startTime = &quot;&quot;;</span>
<span class="fc" id="L238">				String endTime = &quot;&quot;;</span>
<span class="pc bpc" id="L239" title="2 of 4 branches missed.">				if (r.getEndTime() != null &amp;&amp; r.getStartTime() != null) {</span>
<span class="fc" id="L240">					startTime = simpleDateFormat.format(r.getStartTime());</span>
<span class="fc" id="L241">					endTime = simpleDateFormat.format(r.getEndTime());</span>
				}
<span class="fc" id="L243">				String[] data = { String.valueOf(r.getCallNumber()),</span>
<span class="fc" id="L244">						String.valueOf(r.getCalledNumber()), r.getCallTypeName(), startTime, endTime,</span>
<span class="fc" id="L245">						String.valueOf((long) Math.ceil(holdingTime)), String.valueOf((double) r.getFee() / 1000) };</span>
<span class="fc" id="L246">				dataList.add(data);</span>
<span class="fc" id="L247">			}</span>
<span class="fc" id="L248">			map = createExcel(&quot;cdr黑户话单&quot;+dateFormat.format(new Date())+&quot;.xls&quot;, columns, dataList, numberFlag);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">		} else if (&quot;2&quot;.equals(resourceType)) {</span>
<span class="fc" id="L250">			List&lt;RatedDma&gt; list = ratedDmaDao.queryDmaBlackCallListResult(req);</span>

<span class="fc" id="L252">			String[] columns = { LOGIN_NAME, &quot;方数&quot;, &quot;会议号&quot;, &quot;会议起始时间&quot;, &quot;会议结束时间&quot;, &quot;时长/(时)&quot;, FEE, &quot;保障费/(元)&quot; };</span>
<span class="fc" id="L253">			boolean[] numberFlag = { false, false, false, false, false, true, true, true };</span>
<span class="fc" id="L254">			List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">			for (RatedDma r : list) {</span>
<span class="fc" id="L256">				double holdingTime = (double) r.getHoldingTime() / (60 * 60);</span>
<span class="fc" id="L257">				String[] data = { String.valueOf(r.getUserId()),</span>
<span class="fc" id="L258">						String.valueOf(r.getPartCount()), String.valueOf(r.getRoomId()),</span>
<span class="fc" id="L259">						simpleDateFormat.format(r.getStartTime()), simpleDateFormat.format(r.getEndTime()),</span>
<span class="fc" id="L260">						String.valueOf((long) Math.ceil(holdingTime)),</span>
<span class="fc" id="L261">						String.valueOf((double) r.getFee() / 1000),</span>
<span class="fc" id="L262">						String.valueOf((double) r.getOtherFee() / 1000)};</span>
<span class="fc" id="L263">				dataList.add(data);</span>
<span class="fc" id="L264">			}</span>
<span class="fc" id="L265">			map = createExcel(&quot;dma黑户话单&quot;+dateFormat.format(new Date())+&quot;.xls&quot;, columns, dataList,numberFlag);</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">		} else if (&quot;3&quot;.equals(resourceType)) {</span>
<span class="fc" id="L267">			List&lt;RatedNetwork&gt; list = ratedNetworkDao.queryNetworkBlackCallListResult(req);</span>
<span class="fc" id="L268">			map = createNetworkExcel(list, &quot;网络专线黑户话单&quot;+dateFormat.format(new Date())+&quot;.xls&quot;);</span>
		}
<span class="fc" id="L270">		return map;</span>
	}

	public void cdrListToRespList(List&lt;QueryCallListResp&gt; callList, List&lt;RatedCdr&gt; list, String callTypeId) {
<span class="fc bfc" id="L274" title="All 2 branches covered.">		for (RatedCdr ratedCdr : list) {</span>
<span class="fc" id="L275">			QueryCallListResp callListResp = new QueryCallListResp();</span>
<span class="pc bpc" id="L276" title="2 of 4 branches missed.">			if (ratedCdr.getEndTime() != null &amp;&amp; ratedCdr.getStartTime() != null) {</span>
<span class="fc" id="L277">				double holdingTime = (double) ratedCdr.getHoldingTime() / 60;// 单位min</span>
<span class="fc" id="L278">				callListResp.setStartTime(simpleDateFormat.format(ratedCdr.getStartTime()));</span>
<span class="fc" id="L279">				callListResp.setEndTime(simpleDateFormat.format(ratedCdr.getEndTime()));</span>
<span class="fc" id="L280">				callListResp.setHoldingTime(String.valueOf((long) Math.ceil(holdingTime)));</span>
			}
<span class="fc" id="L282">			callListResp.setCallNumber(String.valueOf(ratedCdr.getCallNumber()));</span>
<span class="fc" id="L283">			callListResp.setCalledNumber(String.valueOf(ratedCdr.getCalledNumber()));</span>
<span class="fc" id="L284">			callListResp.setRegion(String.valueOf(ratedCdr.getRegion()));</span>
<span class="fc" id="L285">			callListResp.setFee(String.valueOf((double) ratedCdr.getFee() / 1000));</span>
<span class="fc" id="L286">			callListResp.setOperatorId(String.valueOf(ratedCdr.getUserId()));</span>
<span class="fc" id="L287">			callListResp.setOperatorName(String.valueOf(ratedCdr.getOperatorName()));</span>
<span class="fc" id="L288">			callListResp.setOrgName(String.valueOf(ratedCdr.getOrgName()));</span>
<span class="fc" id="L289">			callListResp.setCount(String.valueOf(ratedCdr.getCount()));</span>
<span class="fc" id="L290">			callListResp.setBillMonth(String.valueOf(ratedCdr.getBillMonth()));</span>
<span class="fc" id="L291">			callListResp.setCallType(ratedCdr.getCallTypeName());</span>
<span class="fc" id="L292">			callListResp.setCdrId(String.valueOf(ratedCdr.getCdrId()));</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">			if (!&quot;&quot;.equals(callTypeId)) {</span>
<span class="fc" id="L294">				callListResp.setCallTypeId(callTypeId);</span>
			}

<span class="fc" id="L297">			callList.add(callListResp);</span>
<span class="fc" id="L298">		}</span>
<span class="fc" id="L299">	}</span>

	public void dmaListToRespList(List&lt;QueryCallListResp&gt; callList, List&lt;RatedDma&gt; list) {
<span class="fc bfc" id="L302" title="All 2 branches covered.">		for (RatedDma ratedDma : list) {</span>
<span class="fc" id="L303">			QueryCallListResp callListResp = new QueryCallListResp();</span>
<span class="pc bpc" id="L304" title="2 of 4 branches missed.">			if (ratedDma.getEndTime() != null &amp;&amp; ratedDma.getStartTime() != null) {</span>
<span class="fc" id="L305">				double holdingTime = (double) ratedDma.getHoldingTime() / (60 * 60);// 单位h</span>
<span class="fc" id="L306">				callListResp.setStartTime(simpleDateFormat.format(ratedDma.getStartTime()));</span>
<span class="fc" id="L307">				callListResp.setEndTime(simpleDateFormat.format(ratedDma.getEndTime()));</span>
<span class="fc" id="L308">				callListResp.setHoldingTime(String.valueOf((long) Math.ceil(holdingTime)));</span>
			}
<span class="fc" id="L310">			callListResp.setOperatorId(String.valueOf(ratedDma.getUserId()));</span>
<span class="fc" id="L311">			callListResp.setIp(String.valueOf(ratedDma.getIp()));</span>
<span class="fc" id="L312">			callListResp.setTerminalName(String.valueOf(ratedDma.getTerminalName()));</span>
<span class="fc" id="L313">			callListResp.setConferenceNumber(String.valueOf(ratedDma.getRoomId()));</span>
<span class="fc" id="L314">			callListResp.setPartCount(String.valueOf(ratedDma.getPartCount()));</span>
<span class="fc" id="L315">			callListResp.setFee(String.valueOf((double) ratedDma.getFee() / 1000));</span>
<span class="fc" id="L316">			callListResp.setCount(String.valueOf(ratedDma.getCount()));</span>
<span class="fc" id="L317">			callListResp.setBillMonth(String.valueOf(ratedDma.getBillMonth()));</span>
<span class="fc" id="L318">			callListResp.setOrgId(String.valueOf(ratedDma.getOrgId()));</span>
<span class="fc" id="L319">			callListResp.setOrgName(String.valueOf(ratedDma.getOrgName()));</span>
<span class="fc" id="L320">			callListResp.setOperatorName(String.valueOf(ratedDma.getOperatorName()));</span>
<span class="fc" id="L321">			callListResp.setConfUuid(String.valueOf(ratedDma.getConfUuid()));</span>
<span class="fc" id="L322">			callListResp.setOtherFee(String.valueOf((double) ratedDma.getOtherFee() / 1000));</span>
<span class="fc" id="L323">			callList.add(callListResp);</span>
<span class="fc" id="L324">		}</span>
<span class="fc" id="L325">	}</span>

	public void networkListToRespList(List&lt;QueryCallListResp&gt; callList, List&lt;RatedNetwork&gt; list) {
<span class="fc bfc" id="L328" title="All 2 branches covered.">		for (RatedNetwork ratedNetwork : list) {</span>
<span class="fc" id="L329">			QueryCallListResp callListResp = new QueryCallListResp();</span>
<span class="fc" id="L330">			callListResp.setOrgName(ratedNetwork.getOrgName());</span>
<span class="fc" id="L331">			callListResp.setBillMonth(String.valueOf(ratedNetwork.getBillMonth()));</span>
<span class="fc" id="L332">			callListResp.setFee(String.valueOf((double) ratedNetwork.getFee() / 1000));</span>
<span class="fc" id="L333">			callListResp.setFeeType(ratedNetwork.getFeeType());</span>
<span class="fc" id="L334">			callList.add(callListResp);</span>
<span class="fc" id="L335">		}</span>
<span class="fc" id="L336">	}</span>

	private Map&lt;String, String&gt; createExcel(String fileName, String[] columns,
			List&lt;String[]&gt; dataList, boolean[] numberFlag) {
<span class="fc" id="L340">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L341">		String path = PATH + fileName;</span>

		try {
<span class="fc" id="L344">			map.put(FILE_NAME, URLEncoder.encode(fileName , &quot;UTF-8&quot;));</span>
<span class="fc" id="L345">			JxlTool.exportExcel(path, columns, dataList, numberFlag);</span>
<span class="nc" id="L346">		} catch (Exception e) {</span>
<span class="nc" id="L347">			LOGGER.error(&quot;exportExcel err.&quot;, e);</span>
<span class="nc" id="L348">			map.put(STATUS, ERROR);</span>
<span class="nc" id="L349">			return map;</span>
<span class="fc" id="L350">		}</span>
<span class="fc" id="L351">		map.put(STATUS, SUCCESS);</span>
<span class="fc" id="L352">		return map;</span>
	}

	private Map&lt;String, String&gt; createNetworkExcel(List&lt;RatedNetwork&gt; list, String fileName) {
<span class="fc" id="L356">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L357">		String path = PATH + fileName;</span>
<span class="fc" id="L358">		String[] columns = { &quot;单位名称&quot;, &quot;月份&quot;, FEE };</span>
<span class="fc" id="L359">		boolean[] numberFlag = { false, false, true };</span>
<span class="fc" id="L360">		List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">		for (RatedNetwork r : list) {</span>
<span class="fc" id="L362">			String[] data = { String.valueOf(r.getOrgName()),</span>
<span class="fc" id="L363">					String.valueOf(r.getBillMonth()), String.valueOf((double) r.getFee() / 1000) };</span>
<span class="fc" id="L364">			dataList.add(data);</span>
<span class="fc" id="L365">		}</span>
		try {
<span class="fc" id="L367">			map.put(FILE_NAME, URLEncoder.encode(fileName , &quot;UTF-8&quot;));</span>
<span class="fc" id="L368">			JxlTool.exportExcel(path, columns, dataList,numberFlag);</span>
<span class="nc" id="L369">		} catch (Exception e) {</span>
<span class="nc" id="L370">			LOGGER.error(&quot;Network exportExcel err.&quot;, e);</span>
<span class="nc" id="L371">			map.put(STATUS, ERROR);</span>
<span class="nc" id="L372">			return map;</span>
<span class="fc" id="L373">		}</span>
<span class="fc" id="L374">		map.put(STATUS, SUCCESS);</span>
<span class="fc" id="L375">		return map;</span>
	}

	@Override
	public Map&lt;String, Object&gt; queryBlackUserListResult(QueryCallListReq req, int page, int size) {
<span class="fc" id="L380">		List&lt;QueryCallListResp&gt; callList = new ArrayList&lt;QueryCallListResp&gt;();</span>
<span class="fc" id="L381">		String resourceType = req.getResourceType();</span>
<span class="fc" id="L382">		Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L383">		PageHelper.clearPage();</span>
<span class="fc" id="L384">		PageHelper.startPage(page, size);</span>
<span class="fc" id="L385">		long total = 0l;</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">		if (&quot;1&quot;.equals(resourceType)) {</span>
<span class="fc" id="L387">			List&lt;RatedCdr&gt; originList = ratedCdrDao.queryCdrBlackUsersResult(req);</span>
<span class="fc" id="L388">			PageInfo&lt;RatedCdr&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L389">			total = pageInfo.getTotal();</span>
<span class="fc" id="L390">			List&lt;RatedCdr&gt; list = pageInfo.getList();</span>
<span class="fc" id="L391">			cdrListToRespList(callList, list, req.getCallType());</span>
<span class="fc bfc" id="L392" title="All 2 branches covered.">		} else if (&quot;2&quot;.equals(resourceType)) {</span>
<span class="fc" id="L393">			List&lt;RatedDma&gt; originList = ratedDmaDao.queryDmaBlackUsersResult(req);</span>
<span class="fc" id="L394">			PageInfo&lt;RatedDma&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L395">			total = pageInfo.getTotal();</span>
<span class="fc" id="L396">			List&lt;RatedDma&gt; list = pageInfo.getList();</span>
<span class="fc" id="L397">			dmaListToRespList(callList, list);</span>
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">		} else if (&quot;3&quot;.equals(resourceType)) {</span>
<span class="fc" id="L399">			List&lt;RatedNetwork&gt; originList = ratedNetworkDao.queryNetBlackUsersResult(req);</span>
<span class="fc" id="L400">			PageInfo&lt;RatedNetwork&gt; pageInfo = new PageInfo&lt;&gt;(originList);</span>
<span class="fc" id="L401">			total = pageInfo.getTotal();</span>
<span class="fc" id="L402">			List&lt;RatedNetwork&gt; list = pageInfo.getList();</span>
<span class="fc" id="L403">			networkListToRespList(callList, list);</span>
		}
<span class="fc" id="L405">		map.put(&quot;list&quot;, callList);</span>
<span class="fc" id="L406">		map.put(&quot;cnt&quot;, total);</span>
<span class="fc" id="L407">		return map;</span>
	}

//	@Override
//	public int queryBlackUserListCount(QueryCallListReq req) {
//		String resourceType = req.getResourceType();
//		int count = 0;
//		if (&quot;1&quot;.equals(resourceType)) {
//			count = ratedCdrDao.queryCdrBlackUsersCount(req);
//		} else if (&quot;2&quot;.equals(resourceType)) {
//			count = ratedDmaDao.queryDmaBlackUsersCount(req);
//		} else if (&quot;3&quot;.equals(resourceType)) {
//			count = ratedNetworkDao.queryNetBlackUsersListCount(req);
//		}
//		return count;
//	}

	@Override
	public Map&lt;String, String&gt; createBlackUserListExcel(QueryCallListReq req) {
<span class="fc" id="L426">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L427">		String resourceType = req.getResourceType();</span>
<span class="fc bfc" id="L428" title="All 2 branches covered.">		if (&quot;1&quot;.equals(resourceType)) {</span>
<span class="fc" id="L429">			List&lt;RatedCdr&gt; list = ratedCdrDao.queryCdrBlackUsersResult(req);</span>
<span class="fc" id="L430">			List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc" id="L431">			String[] columns = { &quot;号码&quot;, &quot;话单类型&quot;, &quot;话单数&quot;, FEE, &quot;归属月份&quot; };</span>
<span class="fc" id="L432">			boolean[] numberFlag = { false, false, true, true, false };</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">			for (RatedCdr r : list) {</span>
<span class="fc" id="L434">				String[] data = { String.valueOf(r.getCallNumber()), r.getCallTypeName(), String.valueOf(r.getCount()),</span>
<span class="fc" id="L435">						String.valueOf((double) r.getFee() / 1000), String.valueOf(r.getBillMonth()) };</span>
<span class="fc" id="L436">				dataList.add(data);</span>
<span class="fc" id="L437">			}</span>

<span class="fc" id="L439">			map = createExcel(&quot;cdr黑户用户&quot;+dateFormat.format(new Date())+&quot;.xls&quot;, columns, dataList, numberFlag);</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">		} else if (&quot;2&quot;.equals(resourceType)) {</span>
<span class="fc" id="L441">			List&lt;RatedDma&gt; list = ratedDmaDao.queryDmaBlackUsersResult(req);</span>

<span class="fc" id="L443">			String[] columns = { &quot;会议号&quot;, &quot;话单数&quot;, FEE, &quot;归属月份&quot; };</span>
<span class="fc" id="L444">			boolean[] numberFlag = { false, true, true, false };</span>
<span class="fc" id="L445">			List&lt;String[]&gt; dataList = new ArrayList&lt;String[]&gt;();</span>
<span class="fc bfc" id="L446" title="All 2 branches covered.">			for (RatedDma r : list) {</span>
<span class="fc" id="L447">				String[] data = { String.valueOf(r.getRoomId()), String.valueOf(r.getCount()),</span>
<span class="fc" id="L448">						String.valueOf((double) r.getFee() / 1000), String.valueOf(r.getBillMonth()) };</span>
<span class="fc" id="L449">				dataList.add(data);</span>
<span class="fc" id="L450">			}</span>
<span class="fc" id="L451">			map = createExcel(&quot;dma黑户用户&quot;+dateFormat.format(new Date())+&quot;.xls&quot;, columns, dataList, numberFlag);</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">		} else if (&quot;3&quot;.equals(resourceType)) {</span>
<span class="fc" id="L453">			List&lt;RatedNetwork&gt; list = ratedNetworkDao.queryNetBlackUsersResult(req);</span>
<span class="fc" id="L454">			map = createNetworkExcel(list, &quot;网络专线黑户用户&quot;+dateFormat.format(new Date())+&quot;.xls&quot;);</span>
		}
<span class="fc" id="L456">		return map;</span>
	}

	@Override
	public Map&lt;String, String&gt; editUserInfo(QueryCallListReq req) {
<span class="fc" id="L461">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
		// 根据用户名和部门查询该部门下是否有该用户
<span class="fc" id="L463">		String userName = req.getOperatorName();</span>
<span class="fc" id="L464">		int orgId = req.getOrgId();</span>
<span class="fc" id="L465">		int operatorId = 0;</span>
<span class="fc" id="L466">		String loginName = &quot;&quot;;</span>
<span class="fc" id="L467">		List&lt;Operator&gt; operators = operatorDao.selectIdAndNameByOrgId(orgId);</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		for (Operator operator : operators) {</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">			if (userName.equals(operator.getOperatorName())) {</span>
<span class="nc" id="L470">				operatorId = operator.getOperatorId();</span>
<span class="nc" id="L471">				loginName = operator.getLoginName();</span>
<span class="nc" id="L472">				break;</span>
			}
<span class="nc" id="L474">		}</span>
<span class="pc bpc" id="L475" title="2 of 4 branches missed.">		if (operatorId == 0 &amp;&amp; &quot;&quot;.equals(loginName)) {</span>
<span class="fc" id="L476">			map.put(STATUS, ERROR);</span>
<span class="fc" id="L477">			map.put(&quot;info&quot;, &quot;更新失败,该机构下不存在“&quot; + userName + &quot;”用户，请确认！&quot;);</span>
		} else {
<span class="nc" id="L479">			req.setLoginName(loginName);</span>
<span class="nc" id="L480">			req.setOperatorId(String.valueOf(operatorId));</span>
<span class="nc" id="L481">			ratedCdrDao.updateUserInfo(req);// update by callNumber和billmonth</span>
<span class="nc" id="L482">			insertSummingSettleTask(Integer.parseInt(req.getBillMonth()), 1);</span>
<span class="nc" id="L483">			map.put(STATUS, SUCCESS);</span>
<span class="nc" id="L484">			map.put(&quot;info&quot;, &quot;黑户用户编辑成功&quot;);</span>
		}
<span class="fc" id="L486">		return map;</span>
	}

	@Override
	public Map&lt;String, String&gt; editUserInfoForDetail(QueryCallListReq req) {
		// 根据用户名和部门查询该部门下是否有该用户
<span class="fc" id="L492">		String userName = req.getOperatorName();</span>
<span class="fc" id="L493">		int orgId = req.getOrgId();</span>
<span class="fc" id="L494">		List&lt;Operator&gt; operators = operatorDao.selectIdAndNameByOrgId(orgId);</span>
<span class="fc" id="L495">		int operatorId = 0;</span>
<span class="fc" id="L496">		String loginName = &quot;&quot;;</span>
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">		for (Operator operator : operators) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">			if (userName.equals(operator.getOperatorName())) {</span>
<span class="nc" id="L499">				operatorId = operator.getOperatorId();</span>
<span class="nc" id="L500">				loginName = operator.getLoginName();</span>
<span class="nc" id="L501">				break;</span>
			}
<span class="nc" id="L503">		}</span>
<span class="fc" id="L504">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="pc bpc" id="L505" title="2 of 4 branches missed.">		if (operatorId == 0 &amp;&amp; &quot;&quot;.equals(loginName)) {</span>
<span class="fc" id="L506">			map.put(STATUS, ERROR);</span>
<span class="fc" id="L507">			map.put(&quot;info&quot;, &quot;更新失败,该机构下不存在“&quot; + userName + &quot;”用户，请确认！&quot;);</span>
		} else {
<span class="nc" id="L509">			req.setLoginName(loginName);</span>
<span class="nc" id="L510">			req.setOperatorId(String.valueOf(operatorId));</span>
<span class="nc" id="L511">			ratedCdrDao.updateUserInfoForDetail(req);</span>
<span class="nc" id="L512">			insertSummingSettleTask(Integer.parseInt(req.getBillMonth()), 1);</span>
<span class="nc" id="L513">			map.put(STATUS, SUCCESS);</span>
<span class="nc" id="L514">			map.put(&quot;info&quot;, &quot;黑户用户编辑成功&quot;);</span>
		}
<span class="fc" id="L516">		return map;</span>
	}

	private void insertSummingSettleTask(int billMonth, int cdrType) {
<span class="fc" id="L520">		SummingSettleTask summingSettleTask = new SummingSettleTask();</span>
<span class="fc" id="L521">		summingSettleTask.setBillMonth(billMonth);</span>
<span class="fc" id="L522">		summingSettleTask.setCdrType(cdrType);</span>
<span class="fc" id="L523">		summingSettleTask.setTaskType(1);</span>
<span class="fc" id="L524">		summingSettleTask.setTaskSrc(1);</span>
<span class="fc" id="L525">		summingSettleTask.setCreateTime(new Date());</span>
<span class="fc" id="L526">		ratedCdrDao.insertSummingSettleTask(summingSettleTask);</span>
<span class="fc" id="L527">	}</span>

	@Override
	public Map&lt;String, String&gt; editOrgInfo(QueryCallListReq req) {
<span class="fc" id="L531">		ratedDmaDao.updateOrgInfo(req);</span>
<span class="fc" id="L532">		insertSummingSettleTask(Integer.parseInt(req.getBillMonth()), 3);</span>
<span class="fc" id="L533">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L534">		map.put(STATUS, SUCCESS);</span>
<span class="fc" id="L535">		map.put(&quot;info&quot;, &quot;编辑成功&quot;);</span>
<span class="fc" id="L536">		return map;</span>
	}
	
	@Override
	public Map&lt;String, String&gt; addInsuranceFee(QueryCallListReq req) {
<span class="fc" id="L541">		Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
		// 查询保障费 如果未找到资费需要进行提示“未找到设备保障费资费，请在资费配置中添加”
		// 计算费用 计算设备保障费费用（设备保障费=设备保障费标准*视频总时长）
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">		if (req.isAddFlag()) {</span>
<span class="fc" id="L545">			List&lt;RateRule&gt; rules = getRateRule(req);</span>
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">			if (rules.isEmpty()) {</span>
<span class="fc" id="L547">				map.put(STATUS, ERROR);</span>
<span class="fc" id="L548">				map.put(&quot;info&quot;, &quot;未找到设备保障费资费，请在资费配置中添加！&quot;);</span>
			} else {
<span class="nc" id="L550">				long fee = rules.get(0).getOtherFee() * req.getHoldingTime();</span>
<span class="nc" id="L551">				req.setFee(fee);</span>
<span class="nc" id="L552">				ratedDmaDao.addInsuranceFee(req);</span>
<span class="nc" id="L553">				ratedDmaDao.updateOrgInfoForDetail(req);</span>
<span class="nc" id="L554">				insertSummingSettleTask(Integer.parseInt(req.getBillMonth()), 3);</span>
<span class="nc" id="L555">				map.put(STATUS, SUCCESS);</span>
<span class="nc" id="L556">				map.put(&quot;info&quot;, &quot;编辑成功&quot;);</span>
			}
<span class="fc" id="L558">		} else {</span>
<span class="nc" id="L559">			req.setFee(0l);</span>
<span class="nc" id="L560">			ratedDmaDao.addInsuranceFee(req);</span>
<span class="nc" id="L561">			ratedDmaDao.updateOrgInfoForDetail(req);</span>
<span class="nc" id="L562">			insertSummingSettleTask(Integer.parseInt(req.getBillMonth()), 3);</span>
<span class="nc" id="L563">			map.put(STATUS, SUCCESS);</span>
<span class="nc" id="L564">			map.put(&quot;info&quot;, &quot;编辑成功&quot;);</span>
		}
<span class="fc" id="L566">		return map;</span>
	}

	private List&lt;RateRule&gt; getRateRule(QueryCallListReq req) {
		//先看资费分配表里有没有个性化，有个性化取个性化的
<span class="fc" id="L571">		RateRule rateRule = new RateRule();</span>
<span class="fc" id="L572">		rateRule.setOrgId(req.getOrgId());</span>
<span class="fc" id="L573">		rateRule.setInureDate(req.getStartTime());</span>
<span class="fc" id="L574">		rateRule.setExpireDate(req.getEndTime());</span>
<span class="fc" id="L575">		List&lt;RateRule&gt; rules = rateRuleDao.searchPersonalInsuranceRule(rateRule);</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">		if(rules.isEmpty()){</span>
<span class="fc" id="L577">			rules = rateRuleDao.searchInsuranceRule(rateRule);</span>
		}
<span class="fc" id="L579">		return rules;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>